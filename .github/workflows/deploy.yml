name: Deploy Argus

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/argus
            
            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            
            # Stop PM2 if running (migrated to Docker)
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            
            # Build and deploy with Docker Compose
            docker compose down || true
            docker compose build --no-cache
            docker compose up -d
            
            # Clean up old images
            docker image prune -f
            
            # Build and deploy docs
            echo "Building docs..."
            cd /opt/argus/docs
            npm ci --omit=dev
            npm run build
            
            # Copy to web directory (deploy user has write access via group)
            rm -rf /var/www/argus-docs/* 2>/dev/null || true
            cp -r build/* /var/www/argus-docs/ 2>/dev/null || echo "Docs copy failed - check permissions"
            
            echo "Deploy complete: $(date)"
            cd /opt/argus
            docker compose ps
